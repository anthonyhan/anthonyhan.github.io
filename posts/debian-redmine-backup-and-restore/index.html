<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Debian Redmine å¤‡ä»½ä¸æ¢å¤ | LimboNova</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/about/">About</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Debian Redmine å¤‡ä»½ä¸æ¢å¤</span></h1>

<h2 class="date">2022/01/23</h2>
</div>

<main>
<p>å‡ å¹´å‰è£…äº† Debian ä½œä¸ºæœåŠ¡å™¨ï¼Œé¡ºä¾¿æŠŠä»¥å‰çš„ Bitnami Redmine (Windows) è¿ç§»äº†è¿‡æ¥ã€‚å¥½å¤šå¹´è¿‡å»ä¹Ÿæ²¡å†å»å¹²é¢„ï¼Œç³»ç»Ÿä¸€ç›´ç¨³å®šè¿è¡Œï¼Œæ¯å‘¨å®šæ—¶å¤‡ä»½ã€‚æœ€è¿‘å› ä¸ºè€ƒè™‘è¿ç§»è¿™äº›å·¥å…·åˆ°Dockerä¸Šï¼Œé‡æ–°æ•´ç†ä¸€éå¤‡ä»½å’Œæ¢å¤æµç¨‹ï¼Œä»¥å¤‡ä¸æ—¶ä¹‹éœ€ã€‚</p>
<h2 id="ç³»ç»Ÿéœ€æ±‚">ç³»ç»Ÿéœ€æ±‚</h2>
<ol>
<li>Redmine 3.3 installed with apt on Debian 9 (stretch).</li>
<li>Database: PostgreSQL</li>
</ol>
<h2 id="å¤‡ä»½">å¤‡ä»½</h2>
<h3 id="é…ç½®æ–‡ä»¶">é…ç½®æ–‡ä»¶</h3>
<p>é…ç½®æ–‡ä»¶åŒ…å«è·¯å¾„ï¼š<code>/etc/redmine/{instance}</code></p>
<p>ä¾‹å¦‚ï¼Œé»˜è®¤å®ä¾‹åç§°ä¸º<code>default</code>ï¼Œåˆ™é…ç½®æ–‡ä»¶è·¯å¾„ä¸º<code>/etc/redmine/{default}</code>ã€‚åŒ…å«ä»¥ä¸‹é…ç½®æ–‡ä»¶ï¼š</p>
<ul>
<li>configuration.yml</li>
<li>database.xml</li>
<li>secret_key.txt</li>
</ul>
<h3 id="æ•°æ®åº“">æ•°æ®åº“</h3>
<p>åœ¨å¤‡ä»½è„šæœ¬æ‰§è¡Œç”¨æˆ·çš„ä¸»ç›®å½•åˆ›å»º <code>.pgpass</code> æ–‡ä»¶ï¼ŒåŠ å…¥è¿æ¥æ•°æ®åº“çš„ç”¨æˆ·åå¯†ç ç­‰è¿æ¥ä¿¡æ¯ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">echo <span style="color:#e6db74">&#34;HOST:PORT:DB_NAME:USERNAME:PASSWORD&#34;</span> &gt; ~/.pgpass
</code></pre></div><p>ä¾‹å¦‚ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">echo <span style="color:#e6db74">&#34;localhost:5432:redmine_default:redmine/instances/default:PASSWORD&#34;</span> &gt; ~/.pgpass
</code></pre></div><p>ä½¿ç”¨ pg_dump å¯¼å‡ºæ•°æ®ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pg_dump -U redmine/instances/default -d redmine_default -h localhost -Fc --file<span style="color:#f92672">=</span>/home/redmine/redmine_backup/db_dumps/redmine_<span style="color:#e6db74">`</span>date +%Y-%m-%d<span style="color:#e6db74">`</span>.sqlc 
</code></pre></div><h3 id="é™„ä»¶">é™„ä»¶</h3>
<p>è·¯å¾„ï¼š<code>/var/lib/redmine/${instance}/files</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rsync -a  /var/lib/redmine/default/files /home/redmine/redmine_backup/
</code></pre></div><h3 id="æ’ä»¶">æ’ä»¶</h3>
<p>è·¯å¾„ï¼š<code>/usr/share/redmine/plugins</code></p>
<h3 id="ä¸»é¢˜">ä¸»é¢˜</h3>
<p>è·¯å¾„ï¼š<code>/usr/share/redmine/public/themes</code></p>
<h3 id="å¤‡ä»½è„šæœ¬">å¤‡ä»½è„šæœ¬</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span><span style="color:#75715e"># Redmine Backup Shell</span>
<span style="color:#75715e"># Author: Han Qian</span>
<span style="color:#75715e"># Version: 1.0</span>

<span style="color:#75715e"># Reference: </span>
<span style="color:#75715e">#1. https://www.redmine.org/projects/redmine/wiki/RedmineBackupRestore</span>
<span style="color:#75715e">#2. https://wiki.debian.org/Redmine</span>

echo <span style="color:#e6db74">&#34;Redmine backup start...&#34;</span>

<span style="color:#75715e"># variables</span>
redmine_instance<span style="color:#f92672">=</span>default
backup_root_dir<span style="color:#f92672">=</span>/home/redmine/redmine_backup/<span style="color:#e6db74">${</span>redmine_instance<span style="color:#e6db74">}</span>

echo <span style="color:#e6db74">&#34;Instance:&#34;</span> <span style="color:#e6db74">${</span>redmine_instance<span style="color:#e6db74">}</span>
echo <span style="color:#e6db74">&#34;Backup dir:&#34;</span> <span style="color:#e6db74">${</span>backup_root_dir<span style="color:#e6db74">}</span>
echo <span style="color:#e6db74">&#34;------------------------------&#34;</span>

<span style="color:#75715e"># Configs</span>
echo <span style="color:#e6db74">&#34;backing up configs...&#34;</span>
backup_config_dir<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>backup_root_dir<span style="color:#e6db74">}</span>/config
mkdir -p <span style="color:#e6db74">${</span>backup_config_dir<span style="color:#e6db74">}</span>
sudo rsync -a /etc/redmine/<span style="color:#e6db74">${</span>redmine_instance<span style="color:#e6db74">}</span>/* <span style="color:#e6db74">${</span>backup_config_dir<span style="color:#e6db74">}</span>
echo <span style="color:#e6db74">&#34;backup configs finished&#34;</span>


<span style="color:#75715e"># Database</span>
echo <span style="color:#e6db74">&#34;backing up database...&#34;</span>
backup_db_dir<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>backup_root_dir<span style="color:#e6db74">}</span>/db_dumps
mkdir -p <span style="color:#e6db74">${</span>backup_db_dir<span style="color:#e6db74">}</span>
pg_dump -U redmine/instances/<span style="color:#e6db74">${</span>redmine_instance<span style="color:#e6db74">}</span> -d redmine_<span style="color:#e6db74">${</span>redmine_instance<span style="color:#e6db74">}</span> -h localhost -Fc --file<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>backup_db_dir<span style="color:#e6db74">}</span>/redmine_<span style="color:#e6db74">`</span>date +%Y-%m-%d<span style="color:#e6db74">`</span>.sqlc 
echo <span style="color:#e6db74">&#34;backup database finished&#34;</span>

<span style="color:#75715e"># Attachments</span>
echo <span style="color:#e6db74">&#34;backing up attachments...&#34;</span>
rsync -a  /var/lib/redmine/<span style="color:#e6db74">${</span>redmine_instance<span style="color:#e6db74">}</span>/files <span style="color:#e6db74">${</span>backup_root_dir<span style="color:#e6db74">}</span>
echo <span style="color:#e6db74">&#34;backup attachments finished&#34;</span>

echo <span style="color:#e6db74">&#34;------------------------------&#34;</span>
echo <span style="color:#e6db74">&#34;backup completed!&#34;</span>
</code></pre></div><h2 id="æ¢å¤">æ¢å¤</h2>
<h3 id="æ•°æ®åº“-1">æ•°æ®åº“</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pg_restore -U redmine/instances/default -d redmine_default -h localhost -c redmine_bak.sqlc
</code></pre></div><h3 id="é™„ä»¶-1">é™„ä»¶</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rsync -a  /home/redmine/redmine_backup/ /var/lib/redmine/default/files 
</code></pre></div><h3 id="æ’ä»¶-1">æ’ä»¶</h3>
<ol>
<li>æ¢å¤æ’ä»¶è‡³è·¯å¾„ <code>/usr/share/redmine/plugins</code></li>
<li>æ›´æ–°æ’ä»¶
<pre tabindex="0"><code>cd /var/lib/redmine/default
rake redmine:plugins:migrate RAILS_ENV=production
</code></pre></li>
<li>é‡å¯ Redmine
<pre tabindex="0"><code>cd /var/lib/redmine/default/tmp
touch restart.txt
</code></pre></li>
</ol>
<h3 id="ä¸»é¢˜-1">ä¸»é¢˜</h3>
<p>æ¢å¤ä¸»é¢˜æ–‡ä»¶è·¯å¾„ï¼š<code>/usr/share/redmine/public/themes</code></p>
<h3 id="heading"></h3>
<h3 id="æ¢å¤è„šæœ¬">æ¢å¤è„šæœ¬</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span><span style="color:#75715e"># Redmine Restore Shell</span>
<span style="color:#75715e"># Author: Han Qian</span>
<span style="color:#75715e"># Version: 1.0</span>

<span style="color:#75715e"># Reference: </span>
<span style="color:#75715e">#1. https://www.redmine.org/projects/redmine/wiki/RedmineBackupRestore</span>
<span style="color:#75715e">#2. https://wiki.debian.org/Redmine</span>

echo <span style="color:#e6db74">&#34;Redmine restore start...&#34;</span>

<span style="color:#75715e"># variables</span>
redmine_instance<span style="color:#f92672">=</span>default
backup_root_dir<span style="color:#f92672">=</span>/home/redmine/redmine_backup/<span style="color:#e6db74">${</span>redmine_instance<span style="color:#e6db74">}</span>

echo <span style="color:#e6db74">&#34;Instance:&#34;</span> <span style="color:#e6db74">${</span>redmine_instance<span style="color:#e6db74">}</span>
echo <span style="color:#e6db74">&#34;Backup dir:&#34;</span> <span style="color:#e6db74">${</span>backup_root_dir<span style="color:#e6db74">}</span>
echo <span style="color:#e6db74">&#34;------------------------------&#34;</span>

<span style="color:#75715e"># Configs</span>
echo <span style="color:#e6db74">&#34;restoring configs...&#34;</span>
backup_config_dir<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>backup_root_dir<span style="color:#e6db74">}</span>/config
sudo rsync -a <span style="color:#e6db74">${</span>backup_config_dir<span style="color:#e6db74">}</span>/* /etc/redmine/<span style="color:#e6db74">${</span>redmine_instance<span style="color:#e6db74">}</span>/
echo <span style="color:#e6db74">&#34;restore configs finished&#34;</span>


<span style="color:#75715e"># Database</span>
echo <span style="color:#e6db74">&#34;restoring database...&#34;</span>
backup_db_dir<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>backup_root_dir<span style="color:#e6db74">}</span>/db_dumps
pg_restore -U redmine/instances/default -d redmine_default -h localhost -c <span style="color:#e6db74">${</span>backup_db_dir<span style="color:#e6db74">}</span>/redmine_<span style="color:#e6db74">`</span>date +%Y-%m-%d<span style="color:#e6db74">`</span>.sqlc .sqlc
echo <span style="color:#e6db74">&#34;restore database finished&#34;</span>

<span style="color:#75715e"># Attachments</span>
echo <span style="color:#e6db74">&#34;restoring attachments...&#34;</span>
sudo rsync -a <span style="color:#e6db74">${</span>backup_root_dir<span style="color:#e6db74">}</span>/files/* /var/lib/redmine/<span style="color:#e6db74">${</span>redmine_instance<span style="color:#e6db74">}</span>/files/
echo <span style="color:#e6db74">&#34;restore attachments finished&#34;</span>

echo <span style="color:#e6db74">&#34;------------------------------&#34;</span>
echo <span style="color:#e6db74">&#34;restore completed!&#34;</span>

</code></pre></div>
</main>

<script src="https://utteranc.es/client.js"
        repo="anthonyhan/anthonyhan.github.io"
        issue-term="title"
        label="ğŸ’¬comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>


<footer>
  
  
  <hr/>
  Â© 2005-2021 Anthony | <a href="https://github.com/anthonyhan">Github</a> | <a href="https://twitter.com/antonius_hq">Twitter</a>
  
  </footer>
  
  </body>
</html>

